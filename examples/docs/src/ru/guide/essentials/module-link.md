---
titleSuffix: Механизм совместного использования кода между сервисами в Esmx
description: Подробное описание механизма связывания модулей в Esmx, включая совместное использование кода между сервисами, управление зависимостями и реализацию спецификации ESM, чтобы помочь разработчикам создавать эффективные микрофронтенд-приложения.
head:
  - - meta
    - property: keywords
      content: Esmx, связывание модулей, Module Link, ESM, совместное использование кода, управление зависимостями, микрофронтенд
---

# Связывание модулей

Esmx предоставляет полноценный механизм связывания модулей для управления совместным использованием кода и зависимостями между сервисами. Этот механизм реализован на основе спецификации ESM (ECMAScript Module) и поддерживает экспорт и импорт модулей на уровне исходного кода, а также полное управление зависимостями.

### Основные концепции

#### Экспорт модулей
Экспорт модулей — это процесс предоставления доступа к определённым единицам кода (например, компонентам, утилитам и т.д.) из сервиса в формате ESM. Поддерживаются два типа экспорта:
- **Экспорт исходного кода**: прямой экспорт файлов исходного кода из проекта
- **Экспорт зависимостей**: экспорт сторонних пакетов, используемых в проекте

#### Связывание модулей
Импорт модулей — это процесс использования единиц кода, экспортированных другими сервисами. Поддерживаются несколько способов установки:
- **Установка исходного кода**: подходит для среды разработки, поддерживает изменения в реальном времени и горячую перезагрузку
- **Установка пакетов**: подходит для производственной среды, использует готовые сборки

## Экспорт модулей

### Настройка

Настройка экспортируемых модулей в `entry.node.ts`:

```ts title="src/entry.node.ts"
import type { EsmxOptions } from '@esmx/core';

export default {
    modules: {
        exports: [
            // Экспорт файлов исходного кода
            'root:src/components/button.vue',  // Компонент Vue
            'root:src/utils/format.ts',        // Утилита
            // Экспорт сторонних зависимостей
            'npm:vue',                         // Фреймворк Vue
            'npm:vue-router'                   // Vue Router
        ]
    }
} satisfies EsmxOptions;
```

Поддерживаются два типа экспорта:
- `root:*`: экспорт файлов исходного кода, путь относительно корня проекта
- `npm:*`: экспорт сторонних зависимостей, указывается имя пакета

## Импорт модулей

### Настройка

Настройка импортируемых модулей в `entry.node.ts`:

```ts title="src/entry.node.ts"
import type { EsmxOptions } from '@esmx/core';

export default {
    modules: {
        // Настройка связей
        links: {
            // Установка исходного кода: указывает на директорию сборки
            'ssr-remote': 'root:./node_modules/ssr-remote/dist',
            // Установка пакетов: указывает на директорию пакета
            'other-remote': 'root:./node_modules/other-remote'
        },
        // Настройка импорта
        imports: {
            // Использование зависимостей из удалённого модуля
            'vue': 'ssr-remote/npm/vue',
            'vue-router': 'ssr-remote/npm/vue-router'
        }
    }
} satisfies EsmxOptions;
```

Описание настроек:
1. **imports**: настройка локальных путей для удалённых модулей
   - Установка исходного кода: указывает на директорию сборки (dist)
   - Установка пакетов: указывает на директорию пакета

2. **externals**: настройка внешних зависимостей
   - Используется для совместного использования зависимостей из удалённых модулей
   - Избегает дублирования зависимостей
   - Поддерживает совместное использование зависимостей между несколькими модулями

### Способы установки

#### Установка исходного кода
Подходит для среды разработки, поддерживает изменения в реальном времени и горячую перезагрузку.

1. **Workspace**
Рекомендуется для использования в Monorepo:
```ts title="package.json"
{
    "devDependencies": {
        "ssr-remote": "workspace:*"
    }
}
```

2. **Link**
Используется для локальной разработки и отладки:
```ts title="package.json"
{
    "devDependencies": {
        "ssr-remote": "link:../ssr-remote"
    }
}
```

#### Установка пакетов
Подходит для производственной среды, использует готовые сборки.

1. **NPM Registry**
Установка через npm registry:
```ts title="package.json"
{
    "dependencies": {
        "ssr-remote": "^1.0.0"
    }
}
```

2. **Статический сервер**
Установка через HTTP/HTTPS:
```ts title="package.json"
{
    "dependencies": {
        "ssr-remote": "https://cdn.example.com/ssr-remote/1.0.0.tgz"
    }
}
```

## Сборка пакетов

### Настройка

Настройка параметров сборки в `entry.node.ts`:

```ts title="src/entry.node.ts"
import type { EsmxOptions } from '@esmx/core';

export default {
    // Настройка экспорта модулей
    modules: {
        exports: [
            'root:src/components/button.vue',
            'root:src/utils/format.ts',
            'npm:vue'
        ]
    },
    // Настройка сборки
    pack: {
        // Включение сборки
        enable: true,

        // Настройка выходных данных
        outputs: [
            'dist/client/versions/latest.tgz',
            'dist/client/versions/1.0.0.tgz'
        ],

        // Настройка package.json
        packageJson: async (esmx, pkg) => {
            pkg.version = '1.0.0';
            return pkg;
        },

        // Действия перед сборкой
        onBefore: async (esmx, pkg) => {
            // Генерация типов
            // Запуск тестов
            // Обновление документации и т.д.
        },

        // Действия после сборки
        onAfter: async (esmx, pkg, file) => {
            // Загрузка на CDN
            // Публикация в npm-репозиторий
            // Развёртывание в тестовой среде и т.д.
        }
    }
} satisfies EsmxOptions;
```

### Результаты сборки

```
your-app-name.tgz
├── package.json        # Информация о пакете
├── index.js            # Точка входа для production
├── server/             # Ресурсы сервера
│   └── manifest.json   # Маппинг ресурсов сервера
├── node/               # Среда выполнения Node.js
└── client/             # Ресурсы клиента
    └── manifest.json   # Маппинг ресурсов клиента
```

### Процесс публикации

```bash
# 1. Сборка production-версии
esmx build

# 2. Публикация в npm
npm publish dist/versions/your-app-name.tgz
```